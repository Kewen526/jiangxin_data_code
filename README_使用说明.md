# 江鑫数据报表生成系统 - 使用说明

## 📋 系统简介

本系统用于从数据库自动生成四种类型的报表：
- **日报**: 单日数据汇总
- **周报**: 两周对比数据（每家门店8行结构）
- **月报**: 两个月对比数据（与周报结构相同）
- **自定义报表**: 任意两个时间段对比，支持筛选门店

## 🔧 系统特点

1. **使用数据库连接池**：避免高并发时连接数过多，支持多用户同时调用
2. **单文件设计**：所有功能集成在一个 `report_generator.py` 文件中
3. **自动样式格式化**：生成的 Excel 报表自动应用专业样式
4. **容错处理**：数据缺失时自动填充默认值

## 📦 依赖安装

```bash
pip install mysql-connector-python openpyxl
```

## ⚙️ 配置说明

编辑 `report_generator.py` 文件，修改数据库配置：

```python
DB_CONFIG = {
    'host': '8.146.210.145',       # 数据库地址
    'port': 3306,                  # 端口
    'user': 'root',                # 用户名
    'password': 'Kewen888@',       # 密码
    'database': 'jx_data',         # 数据库名（请确认实际数据库名）
    'charset': 'utf8mb4',
    'use_unicode': True,
    'autocommit': True
}
```

**重要**：请确认数据库名称是否为 `jx_data`，如不是请修改！

## 🚀 使用方法

### 方法 1: 直接运行示例

```bash
python3 report_generator.py
```

这将生成所有四种报表的示例。

### 方法 2: 在代码中调用

```python
from report_generator import (
    generate_daily_report,
    generate_weekly_report,
    generate_monthly_report,
    generate_custom_report
)

# 1. 生成日报
generate_daily_report('2025-12-12')

# 2. 生成周报（两周对比）
generate_weekly_report(
    week1_start='2025-11-10',
    week1_end='2025-11-16',
    week2_start='2025-11-17',
    week2_end='2025-11-23'
)

# 3. 生成月报（两个月对比）
generate_monthly_report(
    month1_start='2025-09-01',
    month1_end='2025-09-30',
    month2_start='2025-10-01',
    month2_end='2025-10-31'
)

# 4. 生成自定义报表
generate_custom_report(
    period1_start='2025-10-25',
    period1_end='2025-11-09',
    period2_start='2025-11-10',
    period2_end='2025-11-25',
    shop_ids=None  # None=所有门店，或传入门店ID列表 [1001, 1002, ...]
)
```

### 方法 3: 通过 Web API 调用（需要集成到 Flask/FastAPI）

```python
from flask import Flask, request, send_file
from report_generator import generate_daily_report

app = Flask(__name__)

@app.route('/api/generate_daily_report', methods=['POST'])
def api_daily_report():
    data = request.json
    report_date = data.get('report_date')  # '2025-12-12'

    filename = generate_daily_report(report_date)

    if filename:
        return send_file(filename, as_attachment=True)
    else:
        return {"error": "没有数据"}, 404

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
```

## 📊 报表说明

### 1. 日报结构

每行代表一家门店的当日数据，包含 23 列：

| 列名 | 说明 |
|------|------|
| 星期 | 周几 |
| 日期 | 日期 |
| 序号 | 序号 |
| 运营 | 运营人员 |
| 城市 | 城市 |
| 销售 | 销售人员 |
| 门店 | 门店名称 |
| 曝光人数 | 曝光人数 |
| 访问人数 | 访问人数 |
| 下单人数 | 下单人数 |
| 核销人数 | 核销人数 |
| 下单券数 | 下单券数 |
| 核销券数 | 核销券数 |
| 电话点击 | 电话点击次数 |
| 地址点击 | 地址点击次数 |
| 推广通消耗 | 推广通花费 |
| 好评 | 新增好评数 |
| 意向转化率 | 意向转化率 |
| 下单售价金额 | 下单售价金额 |
| 核销售价金额 | 核销售价金额 |
| 优惠后核销金额 | 优惠后核销金额 |
| 下单人数商圈排名 | 商圈排名 |
| 核销金额商圈排名 | 商圈排名 |

### 2. 周报结构（重点！）

每家门店占 **8 行**，包含两周对比数据：

```
【第 1-3 行】核销相关数据
- 行1: 第一周数据 (2025.11.10-2025.11.16)
- 行2: 第二周数据 (2025.11.17-2025.11.23)
- 行3: 差值 (第二周 - 第一周)

【第 4 行】推广通表头（重复表头行）

【第 5-7 行】推广通相关数据
- 行5: 第一周推广通数据
- 行6: 第二周推广通数据
- 行7: 差值

【第 8 行】下一家门店的核销数据...
```

**核销组字段（16列）**:
- 门店、数据周期、优惠后核销额、曝光人数、访问人数、曝光访问转化率
- 下单人数、下单券数、下单转化率、核销人数、核销券数
- 下单售价金额、核销售价金额、优惠码订单、电话点击、客单价

**推广通组字段（16列）**:
- 门店、数据周期、推广通花费、推广通曝光、推广通点击、推广通点击均价
- 推广通订单量、推广通下单转化率、推广通查看团购、推广通查看电话
- 在线咨询、地址点击、门店收藏、收藏率、新增好评数、留评率

### 3. 月报结构

与周报完全相同，只是时间跨度从周变为月。

### 4. 自定义报表结构

与周报类似，但每家门店只有 **4 行**（省略了中间的表头重复行），且包含 **34 列**（增加了序号、运营、城市、销售字段）。

## 🔍 数据来源

系统从以下数据表获取数据：

1. **kewen_daily_report** - 可问综合日报表（主表）
2. **promotion_daily_report** - 推广日报表
3. **store_stats** - 门店统计表（商圈排名）
4. **platform_accounts** - 平台账号表（运营、销售信息）

## 📈 计算规则

### 转化率计算
- **曝光访问转化率** = 访问人数 / 曝光人数 × 100%
- **下单转化率** = 下单人数 / 访问人数 × 100%
- **推广通下单转化率** = 推广通订单量 / 推广通点击 × 100%
- **收藏率** = 门店收藏 / 访问人数 × 100%
- **留评率** = 新增好评数 / 核销人数 × 100%

### 客单价计算
- **客单价** = 优惠后核销额 / 核销人数

### 推广通点击均价
- **点击均价** = 推广通花费 / 推广通点击

### 差值计算
- **数值类字段**: 第二期数据 - 第一期数据
- **百分比类字段**: 直接相减（如 15% - 14% = 1%）

### 数据聚合规则（周报/月报）
- **累加字段**: 曝光人数、访问人数、下单人数、核销金额、推广通花费等
- **重新计算字段**: 转化率、客单价等派生指标需要根据聚合后的数据重新计算

## ⚠️ 注意事项

1. **数据库连接池**
   - 系统使用连接池，最大连接数设置为 20
   - 多用户并发调用时自动复用连接
   - 每次查询完成后自动归还连接

2. **数据缺失处理**
   - 数值类字段缺失时默认填充 0
   - 百分比类字段缺失时默认填充 "0%"
   - 商圈排名缺失时显示 "--"

3. **时间格式**
   - 输入日期格式: `YYYY-MM-DD`（如 `2025-12-12`）
   - 报表中日期格式: `YYYY.MM.DD`（如 `2025.12.12`）

4. **文件命名**
   - 日报: `日报 非餐 YYYYMMDD HHMMSS.xlsx`
   - 周报: `周报 非餐 YYYYMMDD~YYYYMMDD HHMMSS.xlsx`
   - 月报: `月报 非餐 YYYYMMDD~YYYYMMDD HHMMSS.xlsx`
   - 自定义: `自定义 XX家门店非餐 YYYYMMDD HHMMSS.xlsx`

## 🐛 故障排查

### 问题 1: 数据库连接失败
**错误信息**: `Can't connect to MySQL server`

**解决方案**:
1. 检查数据库地址、端口、用户名、密码是否正确
2. 确认数据库服务器允许远程连接
3. 检查防火墙是否开放 3306 端口
4. 确认网络连接正常

### 问题 2: 没有数据
**错误信息**: `警告：YYYY-MM-DD 没有数据`

**解决方案**:
1. 确认数据库中该日期确实有数据
2. 检查数据库名称是否正确（代码中默认为 `jx_data`）
3. 检查表名是否正确

### 问题 3: 运营、销售字段为空
**原因**: 代码中未实现 `platform_accounts` 表的关联查询

**解决方案**: 需要根据实际的 `platform_accounts.stores_json` 字段结构进行解析并关联

### 问题 4: 连接池耗尽
**错误信息**: `Pool exhausted`

**解决方案**:
1. 增加连接池大小（修改代码中的 `pool_size` 参数）
2. 检查是否有连接泄漏（确保每次使用后都正确关闭）

## 📞 技术支持

如有问题，请检查：
1. 数据库配置是否正确
2. Python 版本是否 >= 3.7
3. 依赖包是否正确安装
4. 数据库表结构是否与代码匹配

## 🔄 更新日志

### v1.0 (2025-12-16)
- ✅ 实现日报生成功能
- ✅ 实现周报生成功能（两周对比，8行结构）
- ✅ 实现月报生成功能
- ✅ 实现自定义报表生成功能
- ✅ 集成数据库连接池
- ✅ 自动应用 Excel 样式

## 📄 许可证

内部使用系统
