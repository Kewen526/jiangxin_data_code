# 江鑫数据报表生成系统

## 📁 项目文件说明

```
jiangxin_data_code/
├── report_generator.py          # 核心报表生成系统（主文件）⭐
├── api_server.py               # Web API 服务器
├── requirements.txt            # Python 依赖包列表
├── jx_data_info.sql           # 数据库表结构（参考）
├── 快速开始.md                 # 5分钟快速开始指南 🚀
├── README_使用说明.md          # 详细使用说明文档
├── API_调用示例.md             # API 调用示例和前端集成
├── 项目说明.md                 # 本文件
└── 示例报表/                   # 示例 Excel 报表
    ├── 日报 非餐 20251124.xlsx
    ├── 周报 非餐 20251117~20251123.xlsx
    ├── 月报 非餐 202510.xlsx
    └── 自定义 御林轩养生会所等532家门店非餐 202511.xlsx
```

## 🎯 核心功能

### 1. 报表类型（4 种）

| 报表类型 | 数据跨度 | 特点 | 使用场景 |
|---------|---------|------|---------|
| **日报** | 单日 | 每行一家门店，23 列数据 | 每日数据查看 |
| **周报** | 两周对比 | 每家门店 8 行（两周+差值+推广通） | 周度对比分析 |
| **月报** | 两月对比 | 与周报结构相同 | 月度对比分析 |
| **自定义报表** | 任意时段对比 | 34 列，支持筛选门店 | 灵活查询 |

### 2. 核心特性

✅ **单文件设计** - 所有功能集成在 `report_generator.py` 中
✅ **数据库连接池** - 支持多用户并发，最大 20 个连接
✅ **自动样式** - 自动应用 Excel 边框、对齐、颜色
✅ **容错处理** - 数据缺失时自动填充默认值
✅ **Web API** - 提供 RESTful API 接口
✅ **多种调用方式** - 支持直接调用、API 调用、定时任务

## 🔧 技术架构

### 1. 技术栈

- **Python**: 3.7+
- **数据库**: MySQL 8.0
- **Excel 生成**: openpyxl
- **连接池**: mysql.connector.pooling
- **Web 框架**: Flask（可选）

### 2. 数据源

从以下表获取数据并关联：

| 表名 | 说明 | 主要字段 |
|-----|------|---------|
| `kewen_daily_report` | 可问综合日报表（主表） | 曝光、访问、下单、核销等 60+ 字段 |
| `promotion_daily_report` | 推广日报表 | 推广通相关数据 |
| `store_stats` | 门店统计表 | 商圈排名 |
| `platform_accounts` | 平台账号表 | 运营、销售信息 |

### 3. 数据流程

```
用户输入参数（日期、门店等）
    ↓
数据查询（从连接池获取连接）
    ↓
数据聚合（按日/周/月聚合）
    ↓
计算指标（转化率、差值、客单价等）
    ↓
生成 Excel（openpyxl + 样式）
    ↓
返回文件路径
```

## 📊 数据说明

### 1. 周报结构详解（重点）

周报是最复杂的报表，每家门店占 **8 行**：

```
门店: 沐澜•影院足道•颜系养生SPA （理工大头等舱店）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【核销数据组】
行1: 第一周数据    2025.11.10-2025.11.16  |  12445.6  |  5831  | ...
行2: 第二周数据    2025.11.17-2025.11.23  |  11938.1  |  5712  | ...
行3: 差值          差值                    |  -507.5   |  -119  | ...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【推广通数据组】
行4: [表头] 门店 | 数据周期 | 推广通花费 | 推广通曝光 | ...
行5: 第一周推广通  2025.11.10-2025.11.16  |  1149.38  |  5690  | ...
行6: 第二周推广通  2025.11.17-2025.11.23  |  1071.82  |  5438  | ...
行7: 差值          差值                    |  -77.56   |  -252  | ...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
行8: 【下一家门店的第 1 行...】
```

### 2. 计算规则

#### 转化率计算
```python
曝光访问转化率 = 访问人数 / 曝光人数 × 100%
下单转化率 = 下单人数 / 访问人数 × 100%
推广通下单转化率 = 推广通订单量 / 推广通点击 × 100%
收藏率 = 门店收藏 / 访问人数 × 100%
留评率 = 新增好评数 / 核销人数 × 100%
```

#### 客单价计算
```python
客单价 = 优惠后核销额 / 核销人数
```

#### 差值计算
```python
# 数值类字段
差值 = 第二期 - 第一期

# 百分比类字段
差值 = 第二期百分比 - 第一期百分比  # 如 15% - 14% = 1%
```

#### 数据聚合（周报/月报）
```python
# 累加字段（直接相加）
SUM(曝光人数), SUM(访问人数), SUM(核销金额), ...

# 比率字段（重新计算）
客单价 = SUM(优惠后核销额) / SUM(核销人数)
转化率 = SUM(下单人数) / SUM(访问人数)
```

## 🚀 使用方式

### 方式 1: 直接调用（Python）

```python
from report_generator import generate_daily_report

generate_daily_report('2025-12-12')
```

### 方式 2: API 调用（HTTP）

```bash
curl -X POST http://localhost:5000/api/reports/daily \
  -H "Content-Type: application/json" \
  -d '{"report_date": "2025-12-12"}' \
  --output 日报.xlsx
```

### 方式 3: 定时任务（Cron）

```bash
# 每天凌晨 1 点自动生成昨日日报
0 1 * * * python3 /path/to/report_generator.py
```

## 📖 文档说明

| 文档 | 说明 | 适用人群 |
|-----|------|---------|
| **快速开始.md** | 5 分钟快速部署 | 新用户 |
| **README_使用说明.md** | 详细功能说明 | 所有用户 |
| **API_调用示例.md** | API 调用示例 | 前端开发者 |
| **项目说明.md** | 项目概览（本文件） | 项目管理者 |

## ⚠️ 重要注意事项

### 1. 数据库配置

**必须确认数据库名称！**

编辑 `report_generator.py` 第 22 行：

```python
'database': 'jx_data',  # ⚠️ 请确认是否正确！
```

如果数据库名称不是 `jx_data`，请修改为实际名称！

### 2. 连接池配置

代码已使用连接池，最大连接数 20：

```python
CONNECTION_POOL = mysql.connector.pooling.MySQLConnectionPool(
    pool_name="jx_pool",
    pool_size=20,  # 可根据并发量调整
    ...
)
```

### 3. 性能说明

- **单个报表生成时间**: 2-5 秒
- **支持并发数**: 最多 20 个（连接池大小）
- **建议部署方式**: Gunicorn 多进程 + Nginx

### 4. 数据完整性

代码会自动处理数据缺失情况：
- 数值类字段缺失 → 填充 0
- 百分比类字段缺失 → 填充 "0%"
- 商圈排名缺失 → 显示 "--"

## 🐛 故障排查

| 问题 | 原因 | 解决方案 |
|-----|------|---------|
| 数据库连接失败 | 防火墙/网络问题 | 检查防火墙、MySQL 配置 |
| 没有数据 | 数据库中无数据 | 检查数据库名称、表名 |
| 运营/销售为空 | 未关联 platform_accounts | 需要解析 stores_json 字段 |
| 导入模块失败 | 依赖未安装 | pip3 install -r requirements.txt |

## 📈 后续优化方向

### 1. 功能增强
- [ ] 支持更多报表类型（年报、季报）
- [ ] 支持自定义字段选择
- [ ] 支持多维度筛选（城市、运营组）
- [ ] 支持图表生成（柱状图、折线图）

### 2. 性能优化
- [ ] 引入 Redis 缓存
- [ ] 异步任务队列（Celery）
- [ ] 报表预生成（提前生成常用报表）

### 3. 用户体验
- [ ] Web 可视化界面
- [ ] 报表模板管理
- [ ] 历史报表查看

## 📞 联系方式

- **项目位置**: `/home/user/jiangxin_data_code`
- **Git 仓库**: `claude/create-report-tables-Tt0Wb` 分支
- **数据库**: `8.146.210.145:3306`

## 📝 版本历史

### v1.0 (2025-12-16)
- ✅ 实现日报、周报、月报、自定义报表生成
- ✅ 集成数据库连接池
- ✅ 提供 Web API 接口
- ✅ 自动应用 Excel 样式
- ✅ 完整的文档支持

---

**开始使用**: 请查看 `快速开始.md` 🚀

**问题反馈**: 遇到问题请检查 `README_使用说明.md` 的"故障排查"章节
